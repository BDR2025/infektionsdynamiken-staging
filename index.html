<!doctype html>
<html lang="de" data-mode="school" data-page="staging-login">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staging Login · Infektionsdynamiken</title> 

  <!-- Minimaler Style-Bridge: Tokens + Basiskomponenten (Subset) -->
  <style>
    /* Tokens — angelehnt an deine tokens.css (Subset) */
    :root{
      --font-sans: system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      --step--1:.875rem; --step-0:1rem; --step-1:1.125rem; --step-2:1.25rem; --step-3:1.5rem; --step-4:1.875rem;
      --space-2:.5rem; --space-3:.75rem; --space-4:1rem; --space-6:1.5rem; --space-8:2rem; --space-10:2.5rem;
      --radius-md:.75rem; --radius-lg:1rem;
      --shadow-1:0 2px 8px rgba(0,0,0,.06);
      --bg:#fff; --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --panel:#fafafa;
      --brand:#1aa36f;  /* School */
      --focus:0 0 0 3px color-mix(in srgb, var(--brand) 35%, transparent);
    }
    html,body{height:100%}
    body{margin:0; font:16px/1.5 var(--font-sans); color:var(--fg); background:var(--bg)}
    .container{ width:min(680px, 92vw); margin: clamp(32px,6vh,80px) auto; padding: 0 var(--space-4); }
    .section-card{
      background:var(--panel); border:1px solid var(--border); border-radius:var(--radius-lg);
      box-shadow:var(--shadow-1); padding:clamp(16px,2.2vw,28px);
    }
    h1{ font-size:var(--step-3); margin:.25rem 0 var(--space-3) }
    .eyebrow{ display:block; font-size:var(--step--1); letter-spacing:.04em; text-transform:uppercase; color:var(--muted) }
    .accent{ height:2px; background: color-mix(in srgb, var(--brand) 65%, transparent); border:0; margin:.35rem 0 var(--space-3) }
    .lead{ font-size:var(--step-1); color:var(--muted); margin:0 0 var(--space-4) }
    .form{ display:grid; gap:var(--space-4) }
    label{ display:grid; gap:.4rem; font-weight:600 }
    input[type="password"], input[type="text"]{
      appearance:none; font:inherit; padding:12px 14px; border:1px solid var(--border);
      border-radius:12px; background:#fff; color:inherit;
    }
    input:focus-visible{ outline:2px solid transparent; box-shadow:var(--focus); border-color:var(--brand) }
    .row{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }
    .btn{
      display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .9rem;
      border-radius:var(--radius-md); border:1px solid var(--border); background:#fff; color:var(--fg);
      cursor:pointer; font-weight:500;
    }
    .btn-primary{ background:var(--brand); color:#fff; border-color:transparent }
    .btn-tiny{ font-size:.8rem; padding:.25rem .55rem; border-radius:.5rem; background:#fff }
    .muted{ color:var(--muted); font-size:var(--step--1) }
    .msg{ min-height:1.2em; font-weight:600 }
    .msg.err{ color:#dc2626 }
    .msg.ok{ color:#16a34a }
  </style>
</head>
<body>
  <main class="container">
    <section class="section-card">
      <span class="eyebrow">Staging</span>
      <hr class="accent" />
      <h1>Geschützter Zugang</h1>
      <p class="lead">Diese Staging-Umgebung ist nur für Autor:innen und Reviewer gedacht.</p>

      <form id="loginForm" class="form" autocomplete="off">
        <label for="pw"><span>Passphrase</span>
          <div class="row">
            <input id="pw" type="password" inputmode="text" autocomplete="current-password" placeholder="Passwort eingeben" required />
            <button type="button" class="btn btn-tiny" id="toggle">anzeigen</button>
          </div>
        </label>

        <div class="row">
          <label class="row" style="gap:.4rem;"><input id="remember" type="checkbox" checked /> Angemeldet bleiben (7 Tage)</label>
          <div style="margin-left:auto; display:flex; gap:.5rem;">
            <button type="submit" class="btn btn-primary">Anmelden</button>
          </div>
        </div>

        <div id="msg" class="msg" aria-live="polite"></div>
        <p class="muted">Hinweis: clientseitiger Zugangsschutz (Hash-Vergleich). Für sensible Daten ungeeignet.</p>
      </form>
    </section>
  </main>

  <script>
    /* ===== Staging Gate (clientseitig) ============================= */
    const REDIRECT       = "/app/";      // TODO: Ziel nach Login anpassen
    const SESSION_KEY    = "idv.staging.session";
    const SESSION_DAYS   = 7;            // "Angemeldet bleiben"
    const SESSION_VERSION= "v1";         // bumpen => alle Sessions ungültig
    const SALT           = "idv:staging:v1"; // bei Rotationen anpassen

    // Passwort-Hashes erlauben (SHA-256(SALT + ":" + passphrase))
    const ALLOWED = [
      { label:"team", sha256:"PASTE_HASH_HERE", until:"2099-12-31" }
      // mehrere Einträge möglich; "until" optional
    ];

    // Web Crypto: SHA-256 → hex
    async function sha256Hex(str){
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    const now = () => Date.now();
    const days = n => n*24*60*60*1000;

    function saveSession(fingerprint, daysValid){
      const exp = now() + days(daysValid ?? SESSION_DAYS);
      localStorage.setItem(SESSION_KEY, JSON.stringify({ v:SESSION_VERSION, exp, fp:fingerprint }));
    }

    async function alreadyLoggedIn(){
      try{
        const raw = localStorage.getItem(SESSION_KEY);
        if(!raw) return false;
        const s = JSON.parse(raw);
        if(s.v !== SESSION_VERSION || s.exp < now()) return false;
        const fp = await sha256Hex(navigator.userAgent + "|" + SALT);
        return s.fp === fp;
      }catch(e){ return false; }
    }

    (async () => {                  // Auto-Redirect wenn schon eingeloggt
      if(await alreadyLoggedIn()) location.replace(REDIRECT);
    })();

    // UI
    const $ = sel => document.querySelector(sel);
    $("#toggle").addEventListener("click", () => {
      const el = $("#pw"); el.type = el.type === "password" ? "text" : "password";
      $("#toggle").textContent = (el.type === "password") ? "anzeigen" : "verbergen";
    });

    $("#loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = $("#msg"); msg.textContent=""; msg.className="msg";
      const pw = $("#pw").value.trim();
      if(!pw){ msg.textContent="Bitte Passphrase eingeben."; msg.classList.add("err"); return; }

      const digest = await sha256Hex(SALT + ":" + pw);
      const ok = ALLOWED.find(x => x.sha256 === digest && (!x.until || Date.parse(x.until) >= now()));
      if(!ok){ msg.textContent="Falsche Passphrase."; msg.classList.add("err"); return; }

      const fp = await sha256Hex(navigator.userAgent + "|" + SALT);
      saveSession(fp, $("#remember").checked ? SESSION_DAYS : 0.5); // sonst 12h
      msg.textContent="Erfolg – weiterleiten …"; msg.classList.add("ok");
      location.href = REDIRECT;
    });
  </script>
</body>
</html>
